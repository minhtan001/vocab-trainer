<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vocab Trainer v4.1</title>
  <style>
    :root{--bg:#f4f6fb;--card:#ffffff;--muted:#6b7280;--accent:#2563eb}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Segoe UI,Roboto,Arial;background:var(--bg);color:#111}
    .app{display:flex;min-height:100vh}
    .sidebar{width:320px;background:linear-gradient(180deg,#ffffff, #fbfdff);border-right:1px solid #e6eef9;padding:18px}
    .brand{font-weight:700;font-size:18px;color:var(--accent);margin-bottom:12px}
    .lists{margin-top:10px}
    .list-item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;cursor:pointer}
    .list-item:hover{background:#f1f6ff}
    .list-item.active{background:linear-gradient(90deg, #eef6ff, #ffffff);border-left:3px solid var(--accent);padding-left:5px}
    .controls{display:flex;gap:8px;margin-top:12px}
    .btn{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
    .btn.alt{background:#e6eef9;color:var(--accent)}
    main{flex:1;padding:20px}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 1px 4px rgba(16,24,40,0.04);margin-bottom:14px}
    h2{margin:0 0 8px 0}
    .word-table{width:100%;border-collapse:collapse}
    table th,table td{padding:8px;text-align:left;border-bottom:1px solid #f1f5f9}
    .small{font-size:13px;color:var(--muted)}
    input[type=text],textarea,select{padding:8px;border-radius:8px;border:1px solid #dbeafe;width:100%}
    .flex{display:flex;gap:10px;align-items:center}
    .right{margin-left:auto}
    .chip{padding:6px 8px;border-radius:999px;background:#f1f5f9;font-size:13px}
    .toggle{display:inline-flex;align-items:center;gap:8px}
    .learn-controls{display:flex;gap:10px;flex-wrap:wrap}
    .hidden{display:none}
    .footer{font-size:13px;color:var(--muted);margin-top:10px}
    @media(max-width:900px){.sidebar{display:none}.app{flex-direction:column}.sidebar.mobile{display:block;width:100%}}
    .lang-select{float:right}
    .toast{position:fixed;right:18px;bottom:18px;background:#111;color:#fff;padding:10px 14px;border-radius:8px;opacity:0;transform:translateY(8px);transition:all .28s ease;pointer-events:none}
    .toast.show{opacity:1;transform:translateY(0)}
    .action-btn{padding:6px 8px;border-radius:6px;border:none;cursor:pointer}
    .action-small{font-size:13px}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div class="brand">Vocab Trainer v4.1</div>
        <div class="lang-select">
          <select id="uiLang">
            <option value="en">EN</option>
            <option value="vi">VI</option>
          </select>
        </div>
      </div>

      <div><strong id="lblLists">Lists</strong></div>
      <div class="lists" id="lists"></div>

      <div style="margin-top:12px">
        <input id="newListName" placeholder="New list name" />
        <div class="controls">
          <button class="btn" id="createListBtn">Create</button>
          <button class="btn alt" id="importBtn">Import JSON</button>
        </div>
      </div>

      <div class="footer" id="footerTip">Tip: data is saved in your browser (localStorage). You can export/import JSON to transfer.</div>
    </aside>

    <main>
      <div class="card">
        <div style="display:flex;align-items:center;gap:12px">
          <div>
            <h2 id="currentListTitle">(no list)</h2>
            <div class="small" id="listMeta">Select or create a list to begin</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <label class="small">Mode:
              <select id="modeSelect">
                <option value="listening">Listening</option>
                <option value="writing">Writing</option>
                <option value="review">Review Learned</option>
                <option value="mixed">Mixed</option>
              </select>
            </label>
            <label class="small"><input type="checkbox" id="excludeDisabled" checked/> Exclude disabled</label>
            <label class="small"><input type="checkbox" id="randomize" checked/> Randomize</label>
            <button class="btn" id="startLearningBtn" disabled>Start Learning</button>
            <button class="btn alt" id="exportBtn">Export JSON</button>
          </div>
        </div>
      </div>

      <div class="card" id="manageArea">
        <div style="display:flex;gap:12px;align-items:center">
          <div style="flex:1">
            <h3 id="lblWords">Words</h3>
            <div class="small" id="lblWordsDesc">Add, edit, toggle include/learned status for each word.</div>
          </div>
          <div style="display:flex;gap:8px">
            <label class="toggle small"><input type="checkbox" id="showOnlyEnabled" checked/> <span id="lblShowOnlyEnabled">Show only enabled</span></label>
            <label class="toggle small"><input type="checkbox" id="showOnlyUnlearned" /> <span id="lblShowOnlyUnlearned">Show only unlearned</span></label>
          </div>
        </div>

        <div style="margin-top:12px;display:grid;grid-template-columns:1fr 300px;gap:12px">
          <div>
            <table class="word-table" id="wordsTable">
              <thead><tr><th id="thWord">Word</th><th id="thMeaning">Meaning (VI)</th><th class="small" id="thStreak">Streak</th><th class="small" id="thLearned">Learned</th><th class="small" id="thEnabled">Enabled</th><th class="small">Actions</th></tr></thead>
              <tbody id="wordsTbody"></tbody>
            </table>
          </div>
          <div>
            <div style="margin-bottom:8px"><strong id="lblAddEdit">Add / Edit</strong></div>
            <input id="wordInput" placeholder="English word" />
            <div style="height:8px"></div>
            <input id="meaningInput" placeholder="Meaning (Vietnamese) ‚Äî leave empty to auto-translate" />
            <div style="height:8px"></div>
            <div style="display:flex;gap:8px">
              <button class="btn" id="addWordBtn">Add</button>
              <button class="btn alt" id="updateWordBtn" disabled>Update</button>
              <button class="btn alt" id="resetAllProgressBtn">Reset all progress</button>
            </div>
            <div style="height:10px"></div>
            <div>
              <strong id="lblOptions">Options</strong>
              <div class="small" style="margin-top:6px">Show meaning during learning: <label class="toggle"><input type="checkbox" id="showMeaningDuringStudy" checked/></label></div>
              <div class="small" style="margin-top:6px">Correct streak to mark learned: <input id="streakNeeded" type="number" min="1" max="10" value="3" style="width:60px"/></div>
              <div style="height:10px"></div>
              <div class="small">Export/Import list JSON:</div>
              <textarea id="exportArea" rows="6" style="width:100%;margin-top:6px" placeholder='Exported JSON appears here'></textarea>
              <div style="display:flex;gap:8px;margin-top:6px">
                <button class="btn alt" id="copyExportBtn">Copy</button>
                <button class="btn" id="applyImportBtn">Apply Import</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card" id="learningArea" style="display:none">
        <h3 id="lblLearningSession">Learning Session</h3>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <div class="right"><button class="btn" id="stopSessionBtn">Stop</button></div>
        </div>

        <div style="margin-top:12px">
          <div class="card">
            <div style="display:flex;align-items:center;gap:12px">
              <div style="flex:1">
                <div class="small">Progress</div>
                <div id="sessionProgress">0 / 0</div>
              </div>
              <div style="text-align:right">
                <button class="btn alt" id="playWordBtn">üîä Play</button>
                <button class="btn" id="markCorrectBtn">Mark Correct</button>
                <button class="btn alt" id="markWrongBtn">Mark Wrong</button>
              </div>
            </div>

            <div style="margin-top:12px">
              <div style="font-size:22px;font-weight:600" id="studyWord">‚Äî</div>
              <div class="small" id="studyMeaning" style="margin-top:6px; color:var(--muted)"></div>
              <div style="height:8px"></div>
              <input id="studyAnswer" placeholder="Type the word you hear and press Enter"/>
            </div>

            <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
              <div id="sessionResult" class="small"></div>
              <div class="right" id="sessionControls"></div>
            </div>
          </div>

        </div>
      </div>

    </main>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // Data model and persistence
    const STORAGE_KEY = 'vocabTrainer_v4_1_data_v1';
    const LANG_KEY = 'vocabTrainer_v4_1_uiLang';

    let data = { lists: [] };
    let currentListId = null;
    let editingWordId = null;
    let session = null;

    function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
    function loadData(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){ try{ data = JSON.parse(raw); }catch(e){ console.error('Invalid data'); data = {lists:[]}; }}
      if(!data.lists) data.lists = [];
    }

    function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }

    function showToast(text){ const t = document.getElementById('toast'); t.textContent = text; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); }

    // initial sample if empty
    function ensureSample(){ if(data.lists.length===0){
      const listId = uid('list');
      data.lists.push({ id:listId, name:'Sample - Basic', words:[
        { id:uid('w'), word:'apple', meaning:'t√°o', correctStreak:0, learned:false, enabled:true },
        { id:uid('w'), word:'banana', meaning:'chu·ªëi', correctStreak:0, learned:false, enabled:true },
        { id:uid('w'), word:'orange', meaning:'cam', correctStreak:0, learned:false, enabled:true },
        { id:uid('w'), word:'book', meaning:'s√°ch', correctStreak:0, learned:false, enabled:true },
        { id:uid('w'), word:'table', meaning:'b√†n', correctStreak:0, learned:false, enabled:true }
      ]});
      saveData();
    }}

    // UI helpers
    const listsDiv = document.getElementById('lists');
    const currentListTitle = document.getElementById('currentListTitle');
    const listMeta = document.getElementById('listMeta');
    const wordsTbody = document.getElementById('wordsTbody');
    const startLearningBtn = document.getElementById('startLearningBtn');
    const exportArea = document.getElementById('exportArea');

    // Translations for UI labels (EN/VI)
    const UI_TEXT = {
      en: {
        lists: 'Lists',
        tip: 'Tip: data is saved in your browser (localStorage). You can export/import JSON to transfer.',
        create: 'Create',
        import: 'Import JSON',
        startLearning: 'Start Learning',
        exportJSON: 'Export JSON',
        words: 'Words',
        wordsDesc: 'Add, edit, toggle include/learned status for each word.',
        showOnlyEnabled: 'Show only enabled',
        showOnlyUnlearned: 'Show only unlearned',
        addEdit: 'Add / Edit',
        meaningPlaceholder: 'Meaning (Vietnamese) ‚Äî leave empty to auto-translate',
        add: 'Add', update: 'Update', resetProgress: 'Reset Progress',
        resetAll: 'Reset all progress',
        options: 'Options', showMeaning: 'Show meaning during learning', streakNeeded: 'Correct streak to mark learned', learningSession: 'Learning Session', modeAll: 'All words', modeUnlearned: 'Only unlearned', modeLearned: 'Only learned', excludeDisabled: 'Exclude disabled', randomize: 'Randomize', stop: 'Stop', progress: 'Progress', markCorrect: 'Mark Correct', markWrong: 'Mark Wrong', listenAndType: 'Listen and type', typePlaceholder: 'Type the word you hear and press Enter', resetSingleToast: 'Progress reset for'
      },
      vi: {
        lists: 'Danh s√°ch',
        tip: 'Ghi ch√∫: d·ªØ li·ªáu l∆∞u tr√™n tr√¨nh duy·ªát (localStorage). B·∫°n c√≥ th·ªÉ xu·∫•t/nh·∫≠p JSON ƒë·ªÉ chuy·ªÉn d·ªØ li·ªáu.',
        create: 'T·∫°o',
        import: 'Nh·∫≠p JSON',
        startLearning: 'B·∫Øt ƒë·∫ßu h·ªçc',
        exportJSON: 'Xu·∫•t JSON',
        words: 'T·ª´',
        wordsDesc: 'Th√™m, s·ª≠a, b·∫≠t/t·∫Øt t·ª´, theo d√µi ƒë√£ thu·ªôc/ch∆∞a.',
        showOnlyEnabled: 'Ch·ªâ hi·ªÉn th·ªã t·ª´ ƒëang b·∫≠t',
        showOnlyUnlearned: 'Ch·ªâ hi·ªÉn th·ªã t·ª´ ch∆∞a thu·ªôc',
        addEdit: 'Th√™m / S·ª≠a',
        meaningPlaceholder: 'Nghƒ©a (Ti·∫øng Vi·ªát) ‚Äî ƒë·ªÉ tr·ªëng ƒë·ªÉ t·ª± d·ªãch',
        add: 'Th√™m', update: 'C·∫≠p nh·∫≠t', resetProgress: 'ƒê·∫∑t l·∫°i ti·∫øn ƒë·ªô',
        resetAll: 'ƒê·∫∑t l·∫°i t·∫•t c·∫£ ti·∫øn ƒë·ªô',
        options: 'T√πy ch·ªçn', showMeaning: 'Hi·ªán nghƒ©a khi h·ªçc', streakNeeded: 'S·ªë l·∫ßn ƒë√∫ng li√™n ti·∫øp ƒë·ªÉ t√≠nh ƒë√£ thu·ªôc', learningSession: 'Phi√™n h·ªçc', modeAll: 'T·∫•t c·∫£ t·ª´', modeUnlearned: 'Ch·ªâ t·ª´ ch∆∞a thu·ªôc', modeLearned: 'Ch·ªâ t·ª´ ƒë√£ thu·ªôc', excludeDisabled: 'B·ªè qua t·ª´ b·ªã t·∫Øt', randomize: 'Ng·∫´u nhi√™n', stop: 'D·ª´ng', progress: 'Ti·∫øn ƒë·ªô', markCorrect: 'ƒê√°nh d·∫•u ƒë√∫ng', markWrong: 'ƒê√°nh d·∫•u sai', listenAndType: 'Nghe v√† g√µ l·∫°i', typePlaceholder: 'G√µ t·ª´ b·∫°n nghe v√† nh·∫•n Enter', resetSingleToast: 'ƒê√£ ƒë·∫∑t l·∫°i ti·∫øn ƒë·ªô cho'
      }
    };

    function applyUIText(lang){
      const u = UI_TEXT[lang] || UI_TEXT.en;
      document.getElementById('lblLists').textContent = u.lists;
      document.getElementById('footerTip').textContent = u.tip;
      document.getElementById('createListBtn').textContent = u.create;
      document.getElementById('importBtn').textContent = u.import;
      document.getElementById('startLearningBtn').textContent = u.startLearning;
      document.getElementById('exportBtn').textContent = u.exportJSON;
      document.getElementById('lblWords').textContent = u.words;
      document.getElementById('lblWordsDesc').textContent = u.wordsDesc;
      document.getElementById('lblShowOnlyEnabled').textContent = u.showOnlyEnabled;
      document.getElementById('lblShowOnlyUnlearned').textContent = u.showOnlyUnlearned;
      document.getElementById('lblAddEdit').textContent = u.addEdit;
      document.getElementById('meaningInput').placeholder = u.meaningPlaceholder;
      document.getElementById('addWordBtn').textContent = u.add;
      document.getElementById('updateWordBtn').textContent = u.update;
      document.getElementById('resetAllProgressBtn').textContent = u.resetAll;
      document.getElementById('lblOptions').textContent = u.options;
      document.getElementById('lblLearningSession').textContent = u.learningSession;
      document.getElementById('studyAnswer').placeholder = u.typePlaceholder;
      document.getElementById('studyWord').textContent = u.listenAndType;
      document.getElementById('markCorrectBtn').textContent = u.markCorrect;
      document.getElementById('markWrongBtn').textContent = u.markWrong;
    }

    // load UI language preference
    const savedLang = localStorage.getItem(LANG_KEY) || 'en';
    document.getElementById('uiLang').value = savedLang; applyUIText(savedLang);
    document.getElementById('uiLang').addEventListener('change', e=>{ localStorage.setItem(LANG_KEY, e.target.value); applyUIText(e.target.value); });

    // render lists UI
    function renderLists(){ listsDiv.innerHTML='';
      data.lists.forEach(l=>{
        const el = document.createElement('div'); el.className='list-item' + (l.id===currentListId? ' active':'');
        el.onclick = ()=>{ currentListId = l.id; renderAll(); };
        el.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><strong>${escapeHtml(l.name)}</strong><div class="small chip">${l.words.length} words</div></div>
          <div style="display:flex;gap:6px"><button class="btn alt" onclick="event.stopPropagation();renameList('${l.id}')">Rename</button><button class="btn alt" style="background:#fee7e7;color:#b91c1c" onclick="event.stopPropagation();deleteList('${l.id}')">Delete</button></div>`;
        listsDiv.appendChild(el);
      });
    }

    function renameList(id){ const name = prompt('New list name:'); if(name){ const l = data.lists.find(x=>x.id===id); if(l){ l.name = name; saveData(); renderAll(); } }}
    function deleteList(id){ if(!confirm('Delete this list?')) return; data.lists = data.lists.filter(x=>x.id!==id); if(currentListId===id) currentListId = data.lists.length? data.lists[0].id : null; saveData(); renderAll(); }

    function renderAll(){ renderLists(); renderCurrentList(); }

    function renderCurrentList(){ const list = data.lists.find(x=>x.id===currentListId);
      if(!list){ currentListTitle.textContent='(no list)'; listMeta.textContent='Select or create a list to begin'; startLearningBtn.disabled=true; wordsTbody.innerHTML=''; return; }
      currentListTitle.textContent = list.name;
      listMeta.textContent = `${list.words.length} words in this list`;
      startLearningBtn.disabled = list.words.length===0;
      // render words table
      const showOnlyEnabled = document.getElementById('showOnlyEnabled').checked;
      const showOnlyUnlearned = document.getElementById('showOnlyUnlearned').checked;
      wordsTbody.innerHTML='';
      list.words.forEach(w=>{
        if(showOnlyEnabled && !w.enabled) return;
        if(showOnlyUnlearned && w.learned) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(w.word)}</td><td>${escapeHtml(w.meaning)}</td><td class="small">${w.correctStreak}</td><td class="small">${w.learned? 'Yes':'No'}</td><td class="small">${w.enabled? 'Yes':'No'}</td>
          <td style="text-align:right"><button class='action-btn action-small' onclick="editWord('${w.id}')">‚úèÔ∏è</button> <button class='action-btn action-small' onclick="deleteWord('${w.id}')">‚ùå</button> <button class='action-btn action-small' onclick="resetWordProgress('${w.id}')">‚ôªÔ∏è</button></td>`;
        wordsTbody.appendChild(tr);
      });
    }

    function toggleEnable(wordId){ const list = data.lists.find(x=>x.id===currentListId); const w = list.words.find(x=>x.id===wordId); w.enabled = !w.enabled; saveData(); renderCurrentList(); }
    function editWord(wordId){ const list = data.lists.find(x=>x.id===currentListId); const w = list.words.find(x=>x.id===wordId); if(!w) return; editingWordId = w.id; document.getElementById('wordInput').value = w.word; document.getElementById('meaningInput').value = w.meaning; document.getElementById('updateWordBtn').disabled = false; document.getElementById('addWordBtn').disabled = true; }
    function deleteWord(wordId){ if(!confirm('Delete this word?')) return; const list = data.lists.find(x=>x.id===currentListId); list.words = list.words.filter(x=>x.id!==wordId); saveData(); renderCurrentList(); }

    // reset single word progress
    function resetWordProgress(wordId){ const list = data.lists.find(x=>x.id===currentListId); const w = list.words.find(x=>x.id===wordId); if(!w) return; w.correctStreak = 0; w.learned = false; saveData(); renderCurrentList(); const lang = localStorage.getItem(LANG_KEY) || 'en'; const msg = (lang==='vi' ? UI_TEXT.vi.resetSingleToast : UI_TEXT.en.resetSingleToast) + ` "${w.word}"`; showToast(msg); }

    // add/update with auto-translate
    document.getElementById('createListBtn').onclick = ()=>{
      const name = document.getElementById('newListName').value.trim(); if(!name) return alert('Enter a list name');
      const id = uid('list'); data.lists.push({id,name,words:[]}); document.getElementById('newListName').value=''; saveData(); currentListId = id; renderAll();
    }

    async function autoTranslateToVI(text){
      try{
        const url = 'https://api.mymemory.translated.net/get?q=' + encodeURIComponent(text) + '&langpair=en|vi';
        const res = await fetch(url);
        if(!res.ok) throw new Error('Network');
        const j = await res.json();
        const trans = j && j.responseData && j.responseData.translatedText ? j.responseData.translatedText : '';
        return trans || '';
      }catch(e){ console.warn('Auto-translate failed', e); return '';}    }

    document.getElementById('addWordBtn').onclick = async ()=>{
      const wv = document.getElementById('wordInput').value.trim(); let mv = document.getElementById('meaningInput').value.trim();
      if(!wv) return alert('Enter a word'); const list = data.lists.find(x=>x.id===currentListId); if(!list) return alert('Select a list');
      if(!mv){ document.getElementById('meaningInput').placeholder = 'Translating...'; mv = await autoTranslateToVI(wv); document.getElementById('meaningInput').placeholder = 'Meaning (Vietnamese) ‚Äî leave empty to auto-translate'; }
      list.words.push({ id:uid('w'), word:wv, meaning:mv, correctStreak:0, learned:false, enabled:true }); saveData(); renderCurrentList(); document.getElementById('wordInput').value=''; document.getElementById('meaningInput').value=''; showToast('Word added');
    }

    document.getElementById('updateWordBtn').onclick = ()=>{
      if(!editingWordId) return; const list = data.lists.find(x=>x.id===currentListId); const w = list.words.find(x=>x.id===editingWordId); w.word = document.getElementById('wordInput').value.trim(); w.meaning = document.getElementById('meaningInput').value.trim(); editingWordId = null; document.getElementById('updateWordBtn').disabled=true; document.getElementById('addWordBtn').disabled=false; saveData(); renderCurrentList(); document.getElementById('wordInput').value=''; document.getElementById('meaningInput').value=''; showToast('Word updated'); }

    document.getElementById('resetAllProgressBtn').onclick = ()=>{
      if(!confirm('Reset progress for this list?')) return; const list = data.lists.find(x=>x.id===currentListId); list.words.forEach(w=>{ w.correctStreak = 0; w.learned=false; }); saveData(); renderCurrentList(); showToast('All progress reset'); }

    // export/import
    document.getElementById('exportBtn').onclick = ()=>{
      const list = data.lists.find(x=>x.id===currentListId); if(!list) return alert('Select a list'); exportArea.value = JSON.stringify(list, null, 2); }
    document.getElementById('copyExportBtn').onclick = ()=>{ exportArea.select(); document.execCommand('copy'); showToast('Copied'); }
    document.getElementById('applyImportBtn').onclick = ()=>{
      try{ const obj = JSON.parse(exportArea.value); if(!obj || !obj.name || !Array.isArray(obj.words)) return alert('Invalid list JSON'); obj.id = uid('list'); data.lists.push(obj); saveData(); renderAll(); showToast('Imported'); }catch(e){ alert('Invalid JSON'); }
    }

    document.getElementById('importBtn').onclick = ()=>{ const text = prompt('Paste list JSON here (exported JSON format)'); if(!text) return; try{ const obj = JSON.parse(text); if(!obj || !obj.name || !Array.isArray(obj.words)) return alert('Invalid'); obj.id = uid('list'); data.lists.push(obj); saveData(); renderAll(); showToast('Imported'); }catch(e){ alert('Invalid JSON'); }}

    // learning session logic
    function startLearning(){
      const list = data.lists.find(x=>x.id===currentListId);
      if(!list) return alert('Select a list');
      const mode = document.getElementById('modeSelect').value;
      const excludeDisabled = document.getElementById('excludeDisabled').checked;
      const randomize = document.getElementById('randomize').checked;

      let pool = list.words.slice();
      if(excludeDisabled) pool = pool.filter(w=>w.enabled);
      if(mode === 'listening' || mode === 'writing') pool = pool.filter(w=>!w.learned);
      if(mode === 'review') pool = pool.filter(w=>w.learned);
      if(pool.length === 0) return alert('No words match selection.');
      if(randomize) shuffle(pool);

      session = { pool: pool.slice(), index:0, correct:0, wrong:0, newlyLearned:[], mode };
      // set internal showMeaning according to mode
      if(mode === 'listening') session.showMeaning = false; else session.showMeaning = true;

      document.getElementById('learningArea').style.display='block';
      document.getElementById('manageArea').style.display='none';
      document.getElementById('studyAnswer').value='';
      updateSessionUI(); speakCurrent(); document.getElementById('studyAnswer').focus();
    }

    document.getElementById('startLearningBtn').onclick = ()=> startLearning();
    document.getElementById('stopSessionBtn').onclick = ()=>{ if(confirm('Stop session?')) endSession(); }

    function endSession(){ if(!session) return; alert(`Session ended. Correct: ${session.correct}, Wrong: ${session.wrong}, Newly learned: ${session.newlyLearned.length}`); session=null; document.getElementById('learningArea').style.display='none'; document.getElementById('manageArea').style.display='block'; renderCurrentList(); }

    function updateSessionUI(){ if(!session) return; document.getElementById('sessionProgress').textContent = `${session.index+1} / ${session.pool.length}`; const cw = session.pool[session.index]; document.getElementById('studyWord').textContent = session.mode === 'writing' ? (cw.meaning || '‚Äî') : (session.showMeaning ? (cw.meaning || '‚Äî') : 'üîä Listen and type'); document.getElementById('studyMeaning').textContent = session.showMeaning ? cw.meaning || '' : ''; document.getElementById('sessionResult').textContent = `Correct: ${session.correct} ‚Ä¢ Wrong: ${session.wrong}`; }

    function speakCurrent(){ if(!session) return; const cw = session.pool[session.index]; speak(cw.word); }

    document.getElementById('playWordBtn').onclick = () => { if(session) speakCurrent(); }
    document.getElementById('studyAnswer').addEventListener('keydown', (e)=>{ if(e.key === 'Enter') checkAnswer(); });
    document.getElementById('markCorrectBtn').onclick = ()=>{ markResult(true); }
    document.getElementById('markWrongBtn').onclick = ()=>{ markResult(false); }

    function checkAnswer(){ if(!session) return; const input = document.getElementById('studyAnswer').value.trim(); const cw = session.pool[session.index]; const correct = cw.word.trim().toLowerCase(); if(input.toLowerCase() === correct){ markResult(true); } else { markResult(false); } }

    function markResult(isCorrect){ const cw = session.pool[session.index]; const list = data.lists.find(x=>x.id===currentListId); const actual = list.words.find(w=>w.id===cw.id);
      const streakNeeded = parseInt(document.getElementById('streakNeeded').value) || 3;
      if(isCorrect){ session.correct++; actual.correctStreak = (actual.correctStreak||0) + 1; if(actual.correctStreak >= streakNeeded && !actual.learned){ actual.learned = true; session.newlyLearned.push(actual); }
        sessionResultFlash('Correct', true);
      } else { session.wrong++; actual.correctStreak = 0; sessionResultFlash(`Wrong ‚Äî answer: ${actual.word}`, false); }
      saveData();
      if(session.index < session.pool.length - 1){ session.index++; document.getElementById('studyAnswer').value=''; updateSessionUI(); setTimeout(()=>{ speakCurrent(); document.getElementById('studyAnswer').focus(); },800); }
      else { endSession(); }
    }

    function sessionResultFlash(text, ok){ const el = document.getElementById('sessionResult'); el.textContent = text; el.style.color = ok? 'green':'red'; setTimeout(()=>{ if(session) updateSessionUI(); el.style.color=''; },800); }

    // speech
    let voices = [];
    function loadVoices(){ voices = speechSynthesis.getVoices().filter(v=>v.lang.startsWith('en') || v.lang.startsWith('en-'));
      if(!voices.length) voices = speechSynthesis.getVoices(); }
    loadVoices(); window.speechSynthesis.onvoiceschanged = loadVoices;

    function speak(text){ if(!('speechSynthesis' in window)){ alert('SpeechSynthesis not supported in this browser'); return; } const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; if(voices && voices.length) u.voice = voices[0]; u.rate = 0.95; speechSynthesis.cancel(); speechSynthesis.speak(u); }

    // utilities
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
    function escapeHtml(s){ if(!s) return ''; return s.replace(/[&"'<>]/g, c=>({ '&':'&amp;','"':'&quot;',"'":"&#39;",'<':'&lt;','>':'&gt;' }[c])); }

    // events
    document.getElementById('showOnlyEnabled').addEventListener('change', renderCurrentList);
    document.getElementById('showOnlyUnlearned').addEventListener('change', renderCurrentList);

    // initial load
    loadData(); ensureSample(); if(!currentListId && data.lists.length) currentListId = data.lists[0].id; renderAll();
  </script>
</body>
</html>
